{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Home/Documents/GitHub/tv-store/app/actions/admin-actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient } from '@supabase/supabase-js'\r\nimport { revalidatePath } from 'next/cache'\r\n\r\nexport async function deleteUsers(userIds: string[]) {\r\n  try {\r\n    const supabase = createClient(\r\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n    )\r\n\r\n    // Supabase admin deleteUser only takes one ID. We need to loop.\r\n    const results = await Promise.all(\r\n      userIds.map(id => supabase.auth.admin.deleteUser(id))\r\n    )\r\n\r\n    const errors = results.filter(r => r.error).map(r => r.error?.message)\r\n\r\n    if (errors.length > 0) {\r\n      return { success: false, error: `Errores al eliminar: ${errors.join(', ')}` }\r\n    }\r\n\r\n    revalidatePath('/admin')\r\n    return { success: true }\r\n  } catch (error) {\r\n    return { success: false, error: 'Error interno del servidor' }\r\n  }\r\n}\r\n\r\nexport async function updateUserPassword(userId: string, password: string) {\r\n  const supabase = createClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n    {\r\n      auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false\r\n      }\r\n    }\r\n  )\r\n\r\n  const { error } = await supabase.auth.admin.updateUserById(userId, {\r\n    password: password\r\n  })\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidatePath('/admin')\r\n  return { success: true }\r\n}\r\n\r\nexport async function createSubscription(data: any) {\r\n  const supabase = createClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n    {\r\n      auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false\r\n      }\r\n    }\r\n  )\r\n\r\n  // Calcular fechas (30 días por defecto)\r\n  const startDate = new Date()\r\n  const endDate = new Date(startDate)\r\n  endDate.setDate(startDate.getDate() + 30)\r\n\r\n  const { error } = await supabase\r\n    .from('subscriptions')\r\n    .insert({\r\n      user_id: data.user_id,\r\n      plan_id: data.plan_id,\r\n      plan_name: data.plan_name,\r\n      price: parseFloat(data.price),\r\n      status: 'active',\r\n      next_billing_date: endDate.toISOString()\r\n    })\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidatePath('/admin')\r\n  return { success: true }\r\n}\r\n\r\nexport async function createUser(data: any) {\r\n  try {\r\n    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {\r\n      return { success: false, error: \"Configuration Error: SUPABASE_SERVICE_ROLE_KEY is missing\" }\r\n    }\r\n\r\n    const supabase = createClient(\r\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n      process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n      {\r\n        auth: {\r\n          autoRefreshToken: false,\r\n          persistSession: false\r\n        }\r\n      }\r\n    )\r\n\r\n    // Validate input\r\n    if (!data.email || !data.password) {\r\n      return { success: false, error: \"Email y contraseña son obligatorios\" }\r\n    }\r\n    if (data.password.length < 6) {\r\n      return { success: false, error: \"La contraseña debe tener al menos 6 caracteres\" }\r\n    }\r\n\r\n    // 1. Crear usuario en Auth\r\n    const { data: authUser, error: authError } = await supabase.auth.admin.createUser({\r\n      email: data.email,\r\n      password: data.password,\r\n      email_confirm: true,\r\n      user_metadata: {\r\n        first_name: data.first_name,\r\n        last_name: data.last_name,\r\n        full_name: `${data.first_name} ${data.last_name}`.trim()\r\n      }\r\n    })\r\n\r\n    if (authError) return { success: false, error: `Auth Error: ${authError.message}` }\r\n    if (!authUser.user) return { success: false, error: 'No se pudo crear el usuario (No user returned)' }\r\n\r\n    // Force confirm email explicitly\r\n    const { data: updateData, error: confirmError } = await supabase.auth.admin.updateUserById(\r\n      authUser.user.id,\r\n      { email_confirm: true }\r\n    )\r\n\r\n    if (confirmError) {\r\n      console.error('Error forcing email confirmation:', confirmError)\r\n      return { success: false, error: `User created but email confirmation failed: ${confirmError.message}` }\r\n    }\r\n\r\n    // Verify confirmation stuck\r\n    if (!updateData.user?.email_confirmed_at) {\r\n      return { success: false, error: `User created but email_confirmed_at is still null. Update returned: ${JSON.stringify(updateData.user)}` }\r\n    }\r\n\r\n    const userId = authUser.user.id\r\n\r\n    // 2. Actualizar perfil\r\n    const { error: profileError } = await supabase\r\n      .from('profiles')\r\n      .upsert({\r\n        id: userId,\r\n        email: data.email,\r\n        first_name: data.first_name,\r\n        last_name: data.last_name,\r\n        whatsapp: data.whatsapp,\r\n        role: 'user'\r\n      })\r\n\r\n    if (profileError) {\r\n      return { success: false, error: `Usuario creado pero error en perfil: ${profileError.message}` }\r\n    }\r\n\r\n    // 3. Crear suscripción si hay plan seleccionado\r\n    if (data.plan_id) {\r\n      // Calcular fecha de fin (30 días por defecto)\r\n      const startDate = new Date()\r\n      const endDate = new Date(startDate)\r\n      endDate.setDate(startDate.getDate() + 30)\r\n\r\n      const { error: subError } = await supabase\r\n        .from('subscriptions')\r\n        .insert({\r\n          user_id: userId,\r\n          plan_id: data.plan_id,\r\n          plan_name: data.plan_name,\r\n          price: parseFloat(data.price),\r\n          status: 'active',\r\n          next_billing_date: endDate.toISOString()\r\n        })\r\n\r\n      if (subError) console.error('Error creando suscripción:', subError)\r\n    }\r\n\r\n    // 4. Crear credenciales IPTV si se proporcionaron\r\n    if (data.iptv_username && data.iptv_password) {\r\n      const { error: credError } = await supabase\r\n        .from('credentials')\r\n        .insert({\r\n          user_id: userId,\r\n          username: data.iptv_username,\r\n          password: data.iptv_password\r\n        })\r\n      if (credError) console.error('Error creando credenciales:', credError)\r\n    }\r\n\r\n    revalidatePath('/admin')\r\n    return { success: true, userId }\r\n  } catch (error) {\r\n    console.error('Error en createUser:', error)\r\n    return { success: false, error: 'Error interno del servidor al crear usuario' }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 228, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Home/Documents/GitHub/tv-store/.next-internal/server/app/admin/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {deleteUsers as '4069bffd906f580317c83b27ebd47041d32fdffc67'} from 'ACTIONS_MODULE0'\nexport {createUser as '403739e3b10e9955117a125dee4712007ffc7d872a'} from 'ACTIONS_MODULE0'\nexport {updateUserPassword as '606f206989396dd759909841be0f849a913574d987'} from 'ACTIONS_MODULE0'\nexport {createSubscription as '4074c2839094703f0b22dc44c5c952ba5260831330'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA","debugId":null}}]
}