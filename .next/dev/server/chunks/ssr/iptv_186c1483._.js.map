{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Home/Downloads/iptv/app/actions/admin-actions.ts"],"sourcesContent":["'use server'\n\nimport { createClient } from '@supabase/supabase-js'\nimport { revalidatePath } from 'next/cache'\n\nexport async function deleteUsers(userIds: string[]) {\n  try {\n    const supabase = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    )\n\n    // Supabase admin deleteUser only takes one ID. We need to loop.\n    const results = await Promise.all(\n      userIds.map(id => supabase.auth.admin.deleteUser(id))\n    )\n\n    const errors = results.filter(r => r.error).map(r => r.error?.message)\n\n    if (errors.length > 0) {\n      return { success: false, error: `Errores al eliminar: ${errors.join(', ')}` }\n    }\n\n    revalidatePath('/admin')\n    return { success: true }\n  } catch (error) {\n    return { success: false, error: 'Error interno del servidor' }\n  }\n}\n\nexport async function updateUserPassword(userId: string, password: string) {\n  const supabase = createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false\n      }\n    }\n  )\n\n  const { error } = await supabase.auth.admin.updateUserById(userId, {\n    password: password\n  })\n\n  if (error) {\n    return { success: false, error: error.message }\n  }\n\n  revalidatePath('/admin')\n  return { success: true }\n}\n\nexport async function createSubscription(data: any) {\n  const supabase = createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false\n      }\n    }\n  )\n\n  // Calcular fechas (30 días por defecto)\n  const startDate = new Date()\n  const endDate = new Date(startDate)\n  endDate.setDate(startDate.getDate() + 30)\n\n  const { error } = await supabase\n    .from('subscriptions')\n    .insert({\n      user_id: data.user_id,\n      plan_id: data.plan_id,\n      plan_name: data.plan_name,\n      price: parseFloat(data.price),\n      status: 'active',\n      next_billing_date: endDate.toISOString()\n    })\n\n  if (error) {\n    return { success: false, error: error.message }\n  }\n\n  revalidatePath('/admin')\n  return { success: true }\n}\n\nexport async function createUser(data: any) {\n  try {\n    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {\n      return { success: false, error: \"Configuration Error: SUPABASE_SERVICE_ROLE_KEY is missing\" }\n    }\n\n    const supabase = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!,\n      {\n        auth: {\n          autoRefreshToken: false,\n          persistSession: false\n        }\n      }\n    )\n\n    // Validate input\n    if (!data.email || !data.password) {\n      return { success: false, error: \"Email y contraseña son obligatorios\" }\n    }\n    if (data.password.length < 6) {\n      return { success: false, error: \"La contraseña debe tener al menos 6 caracteres\" }\n    }\n\n    // 1. Crear usuario en Auth\n    const { data: authUser, error: authError } = await supabase.auth.admin.createUser({\n      email: data.email,\n      password: data.password,\n      email_confirm: true,\n      user_metadata: {\n        first_name: data.first_name,\n        last_name: data.last_name,\n        full_name: `${data.first_name} ${data.last_name}`.trim()\n      }\n    })\n\n    if (authError) return { success: false, error: `Auth Error: ${authError.message}` }\n    if (!authUser.user) return { success: false, error: 'No se pudo crear el usuario (No user returned)' }\n\n    // Force confirm email explicitly\n    const { data: updateData, error: confirmError } = await supabase.auth.admin.updateUserById(\n      authUser.user.id,\n      { email_confirm: true }\n    )\n\n    if (confirmError) {\n      console.error('Error forcing email confirmation:', confirmError)\n      return { success: false, error: `User created but email confirmation failed: ${confirmError.message}` }\n    }\n\n    // Verify confirmation stuck\n    if (!updateData.user?.email_confirmed_at) {\n      return { success: false, error: `User created but email_confirmed_at is still null. Update returned: ${JSON.stringify(updateData.user)}` }\n    }\n\n    const userId = authUser.user.id\n\n    // 2. Actualizar perfil\n    const { error: profileError } = await supabase\n      .from('profiles')\n      .upsert({\n        id: userId,\n        email: data.email,\n        first_name: data.first_name,\n        last_name: data.last_name,\n        whatsapp: data.whatsapp,\n        role: 'user'\n      })\n\n    if (profileError) {\n      return { success: false, error: `Usuario creado pero error en perfil: ${profileError.message}` }\n    }\n\n    // 3. Crear suscripción si hay plan seleccionado\n    if (data.plan_id) {\n      // Calcular fecha de fin (30 días por defecto)\n      const startDate = new Date()\n      const endDate = new Date(startDate)\n      endDate.setDate(startDate.getDate() + 30)\n\n      const { error: subError } = await supabase\n        .from('subscriptions')\n        .insert({\n          user_id: userId,\n          plan_id: data.plan_id,\n          plan_name: data.plan_name,\n          price: parseFloat(data.price),\n          status: 'active',\n          next_billing_date: endDate.toISOString()\n        })\n\n      if (subError) console.error('Error creando suscripción:', subError)\n    }\n\n    // 4. Crear credenciales IPTV si se proporcionaron\n    if (data.iptv_username && data.iptv_password) {\n      const { error: credError } = await supabase\n        .from('credentials')\n        .insert({\n          user_id: userId,\n          username: data.iptv_username,\n          password: data.iptv_password\n        })\n      if (credError) console.error('Error creando credenciales:', credError)\n    }\n\n    revalidatePath('/admin')\n    return { success: true, userId }\n  } catch (error) {\n    console.error('Error en createUser:', error)\n    return { success: false, error: 'Error interno del servidor al crear usuario' }\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 228, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Home/Downloads/iptv/.next-internal/server/app/admin/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {deleteUsers as '40e2f6226fd60f4309c44cd8c2ebc1921b80368b36'} from 'ACTIONS_MODULE0'\nexport {createUser as '40c088d894e31615d9e0988719ee5b15b073856c07'} from 'ACTIONS_MODULE0'\nexport {updateUserPassword as '60857e9a2208ac027c8b6bf46806efc59e148114e5'} from 'ACTIONS_MODULE0'\nexport {createSubscription as '406818131b6f3e4ce9e3d9d10335154be68436dde8'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA","debugId":null}}]
}